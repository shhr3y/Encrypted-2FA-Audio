<!doctype html>
<html lang="en-us">

<head>
    <title>ggwave : javascript example</title>

    <head>
        <link rel="stylesheet" href="styles.css">
    </head>
</head>

<body>
    <div id="main-container">
        <br>

        <textarea name="textarea" id="rxData" style="width:300px;height:100px;" disabled></textarea><br>

        <button id="captureStop" hidden>Stop capturing</button>

        <br><br>

    </div>
    <div class="wrapper">
        <form class="form-signin">
            <h2 class="form-signin-heading">Please login</h2>
            <input type="text" value="shrey@gmail.com" class="form-control" name="email" id="user-email"
                placeholder="Email Address" required="" autofocus="" />
            <input type="password" class="form-control" name="password" placeholder="Password" required="" />
            <button class="btn btn-lg btn-primary btn-block" id="login-button" type="submit">Login</button>
        </form>
    </div>

    <script type="text/javascript" src="ggwave.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.0.0/dist/forge.min.js"></script>
    <script type="text/javascript" src="cryptLib.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcb-upLoqTdFfRUL5EGfsUMHQOt3BQ3oQ",
            authDomain: "audio2fa.firebaseapp.com",
            databaseURL: "https://audio2fa-default-rtdb.firebaseio.com",
            projectId: "audio2fa",
            storageBucket: "audio2fa.appspot.com",
            messagingSenderId: "590010512792",
            appId: "1:590010512792:web:9cf634eed5c0314e6267ed"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        window.OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;

        var context = null;
        var recorder = null;

        // the ggwave module instance
        var ggwave = null;
        var parameters = null;
        var instance = null;
        var mediaStream = null;

        // instantiate the ggwave instance
        // ggwave_factory comes from the ggwave.js module
        ggwave_factory().then(function (obj) {
            ggwave = obj;
        });

        var txData = document.getElementById("txData");
        var rxData = document.getElementById("rxData");
        var captureStart = document.getElementById("login-button");
        var captureStop = document.getElementById("captureStop");

        // helper function
        function convertTypedArray(src, type) {
            var buffer = new ArrayBuffer(src.byteLength);
            var baseView = new src.constructor(buffer).set(src);
            return new type(buffer);
        }

        // initialize audio context and ggwave
        function init() {
            if (!context) {
                context = new AudioContext({ sampleRate: 48000 });

                parameters = ggwave.getDefaultParameters();
                parameters.sampleRateInp = context.sampleRate;
                parameters.sampleRateOut = context.sampleRate;
                instance = ggwave.init(parameters);
            }
        }

        captureStart.addEventListener("click", async function () {
            init();
            const dbRef = ref(getDatabase(app));


            let constraints = {
                audio: {
                    // not sure if these are necessary to have
                    echoCancellation: false,
                    autoGainControl: false,
                    noiseSuppression: false
                }
            };

            navigator.mediaDevices.getUserMedia(constraints).then(function (e) {
                mediaStream = context.createMediaStreamSource(e);

                var bufferSize = 1024;
                var numberOfInputChannels = 1;
                var numberOfOutputChannels = 1;

                if (context.createScriptProcessor) {
                    recorder = context.createScriptProcessor(
                        bufferSize,
                        numberOfInputChannels,
                        numberOfOutputChannels);
                } else {
                    recorder = context.createJavaScriptNode(
                        bufferSize,
                        numberOfInputChannels,
                        numberOfOutputChannels);
                }

                recorder.onaudioprocess = async function (e) {
                    var source = e.inputBuffer;
                    var res = ggwave.decode(instance, convertTypedArray(new Float32Array(source.getChannelData(0)), Int8Array));

                    if (res && res.length > 0) {
                        const userEmail = document.getElementById('user-email').value;

                        const users = (await get(child(dbRef, `users/`))).val();
                        var userData = null;
                        for (const userId in users) {
                            const user = users[userId];
                            if (user['email'] === userEmail) {
                                userData = user;
                            }
                        }
                        console.log(userData);

                        const curMin = Math.floor(Date.now() / 60000) * 60;
                        console.log(curMin);
                        const keyId = curMin % userData['keys'].length;
                        const key = userData['keys'][keyId];
                        console.log(keyId, key);


                        res = new TextDecoder("utf-8").decode(res);

                        // var iv = res.substring(0, 16);                     // Use Utf8-Encoder

                        // var ciphertext = CryptoJS.enc.Base64.parse(res.substring(16));    // Use Base64-Encoder.       
                        // // var decryptedWA = CryptoJS.AES.decrypt(res.substring(16), key, { iv: iv });

                        // var encryptedCP = CryptoJS.lib.CipherParams.create({
                        // ciphertext: ciphertext,
                        // formatter: CryptoJS.format.OpenSSL                                     // Optional, but required for encryptedCP.toString() 
                        // });
                        // var decryptedWA = CryptoJS.AES.decrypt(encryptedCP, key, { iv: iv });

                        // var encryptedBase64 = encryptedCP.toString();                              // Short for: encryptedCP.ciphertext.toString(CryptoJS.enc.Base64);
                        // var decryptedUtf8 = decryptedWA.toString(CryptoJS.enc.Utf8);               // Avoid the Base64 detour.
                        // // Alternatively: CryptoJS.enc.Utf8.stringify(decryptedWA);  
                        // var decryptedUtf8 = decryptedWA.toString(CryptoJS.enc.Utf8);
                        // console.log("Ciphertext (Base64)  : " + res)
                        // console.log("Decrypted data (Utf8): " + decryptedUtf8);

                        // var decipher = forge.cipher.createDecipher('AES-CBC', key);
                        // decipher.start({ iv: res.subtring(0, 16) });
                        // decipher.update(res.substring(16));
                        // var result = decipher.finish(); // check 'result' for true/false
                        // outputs decrypted hex
                        // console.log(decipher.output.toString());

                        const decryptedString = cryptLib.decryptCipherTextWithRandomIV(res, key);
                        console.log('decryptedString %s', decryptedString);

                        rxData.value = res;
                    }

                }

                mediaStream.connect(recorder);
                recorder.connect(context.destination);
            }).catch(function (e) {
                console.error(e);
            });

            rxData.value = 'Listening ...';
            captureStop.hidden = false;
        });

        captureStop.addEventListener("click", function () {
            if (recorder) {
                recorder.disconnect(context.destination);
                mediaStream.disconnect(recorder);
                recorder = null;
            }

            rxData.value = 'The transmitted message will apear here!';
            captureStart.hidden = false;
            captureStop.hidden = true;
        });

        captureStop.click();
    </script>
    <script type='text/javascript' src="script.js"></script>
</body>

</html>